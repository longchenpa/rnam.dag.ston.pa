<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="Maxim Sokhatsky" />
    <title>2023-07-05 CMS</title>
    <link rel="stylesheet" href="../../blank.css" />
    <link rel="stylesheet" href="../../journal.css?v=1" />
</head>
<body>
<nav>
    <a href='../../index.html'>5HT</a>
    <a href='../index.html'>TOP</a>
    <a href='#'>2023-07-05</a>
</nav>
<main>
    <section>

    <h3>CMS S/MIME</h3>

    <p>Я бачив багато захищених месанжерів, але всі вони написані людьми, які
        занадто надихалися крипто-стартапами. Крипто-стартап --- це така тєма
        де ти вивчив як крутити чотири функції і думаєш шо готовий запропонувати
        рішення рівня NSA. Але, як показав час, вижило не багато месенжерів.
        Хочу виділити ті захищені месанжери та системи доставки повідомлень,
        які вижили і досі є актуальними, а також розказати як я створюю свій месенжер.</p>

    <h4>IRC PGP OTR</h4>

    <p>Зараз вже відмирає потроху Freenode, як відмирає Reddit та Twitter,
       але всі хто залишився в IRC перейшли в <a href="https://libera.chat">Libera.Chat</a>,
       по-справжньому осучаснений сервер з TLS та OTR плагіном. IRC &mdash; це взагалі
       можна сказати перший месенжер в історії, а PGP &mdash; перший стандарт захищеного обміну повідомленнями.
       PGP (RFC 4880) був розроблений в 1991 році Пилипом Цимерманом і в 2012 аж він став підтримувати ECDH (RFC 6637).
       OTR, або <a href="https://otr.cypherpunks.ca/Protocol-v3-4.0.0.html">Off-the-Record</a>
       на відміну від PGP немає стандарту і був придуманий лише в 2004 році, але активно підтримується
       як плагін у багатьох месенжерах, в тому числі і для IRC. </p>

    <h4>XMPP OTR</h4>

    <p>Перший мій комерційний проект на Erlang був месенжер для малайзійської
       державної компанії, де використовувася протокол XMPP та продукт ejabberd. В
       XMPP світі широко та активно застосовується саме OTR плагін для захищеного
       обміну повідомленнями, хоча я мало бачив людей хто цим реально користується.</p>

    <h4>E-MAIL SMTP PGP</h4>

    <p>Система доставки повідомлень є беззаперечно не тільки першим прото-месенжером,
       але також і першою системою управління бізнес-процесами, тому ці поняття дуже сильно переплітаються.
       Наприклад, якшо уявити шо в месенжері всі повідомлення від невідомих кореспондентів
       попадають не в головний фід чатів, а в спецільних інбокс спочатку, а вже потім перенаправляються
       в певну папку чатів (ростер), то цим можна трохи стерти границю відмінностей в клієнській
       архітектурі між поштою та месенжерами. В SMTP світі домінуючим гравцем на ринку плагінів
       до поштових клієнтів був до недавнього часу PGP.</p>

    <h4>Нестандартизовані месенжери</h4>

    <p>До цього класу можна віднести всі стартапи до яких є хоч трохи довіри, де можна
       повністю скачати і клієнт і сервер і внести небходні зміни за потреби. Це, наприклад,
       Signal, Session, Element. Всі інші, де ви не знаєте шо відбувається, назвати захищеними месенжерами
       можна лише умовно: Telegram, WhatsApp, Threema, Wickr, Facebook, Skype, iMessages.</p>

    <h4>CMS S/MIME</h4>

    <p>Хвиля здорового глузду почала накривати захищені месенжери тільки з 1999 року,
       коли вийшов перший RFC 2630 на синтаксис криптографічних повідомлень CMS.
       Оскільки вся промислова криптографія базується на протоколах описаних в мові ASN.1
       (а це небагато не мало стандарти на CA, X.509, PKI, всі види включів RSA і ECC,
       LDAP, OCSP, TSP, а також ДСТУ стандарти захисту, такі як
       <a href="https://tonpa.guru/stream/2020/2020-02-03 Кваліфікований Електронний Підпис.htm">Кваліфікований
       Електронний Підпис</a>), то логічно аби криптографічні
       захищені повідомлення були частиною цього стандарту. Так і сталося. Текстова
       версія протоколу CMS називається S/MIME і просто містить BASE64 тіло разом з заголовками,
       що ідеально підходить до SMTP протоколу. Зараз CMS S/MIME підтримують майже всі промислові
       поштові клієнти: Thunderbird, Outlook, Postbox, Evolution, MailMate, Nine, MailDroid, iOS Mail.</p>

    <p>Я вважаю шо сучасний відкритий криптографічний месенжер побудований на державних
       стандартах повинен базуватися на цій специфікації. І мій месанжер будується на ції специфікації
       та орієнтується на неї.</p>

    <h3>Дешифрація CMS повідомлення</h3>

    <p>Аби продемонструвати технологію CMS, я покажу початок розробки референсного термінального (консольного) клієнта,
       який буде основою для форків і майбутніх клієнтів на інших платформах. Заодно як ви вже розумієте
       це буде демонстрацією безапеляційної переваги Erlang, який містить безкоштовний промисловий ASN.1
       компілятор, що дозволяє генерувати код прямо з законів України та RFC стандартів.</p>

    <h4>Основи сучасної криптографії</h4>

    <p>Перед початком дамо основи сучасної криптографії в одному параграфі. Для створення спільного
       секретного слова, яким можна було би шифрувати трафік за допомогою симетричного шифру AES
       використовується математичний протокол обміну публічними ключами Діфі-Хелмана
       і його обчислення на сторонах кореспондентів комунікації.Суть протоколу зводить до наступниїх рівнянь: </p>

    <figure><code> roccoK := private(32)
 roccoP := public(roccoK)
 tonpaK := private(32)
 tonpaP := public(tonpaK)
 tonpaS := shared(tonpaK,roccoP)
 roccoS := shared(roccoK,tonpaP)
 roccoS == tonpaS
     </figure></code>

      <p>Два учасники мають пару Публічний та Приватний ключі, які генеруються
         функціями <b>puiblic</b> та <b>private</b>, зазвичай приватний ключ
         є псевдовипадковим числом певної розмірності, а публічний ключ
         утворюється як похідний, який задовільняє умовам рівняння.
         Існує також функція <b>shared</b>, яка дозволяє побудувати похідний
         ключ по парі публічного та приватного ключів різних кореспондентів.
         Якшо попарно схрестити ці дві пари через цю функцію, то отримані
         ключі будуть співпадати &mdash; це називається протокол Діфі-Хелмана.
         Кожна крипто-система на публічних та приватних ключа повинна
         відповідати цим рівнянням.</p>

    <figure><code> outgoing := encrypt(tonpaS)
 send(tonpaP, roccoP, outgoing)
 incoming := receive(roccoP, tonpaP)
 decrypt(incoming)
      </figure></code>

      <p>Далі використовується симетричні алгоритми шифрування такі як AES в
         різних флейворах CCM, GCM, ECB і т.д. Код на мові Erlang виглядає так: </p>

    <figure><code>
    def check_X448_GCM256() do # X488
        scheme = :x448
        {roccoP,roccoK} = :crypto.generate_key(:ecdh, scheme)
        {maximP,maximK} = :crypto.generate_key(:ecdh, scheme)
        maximS = :binary.part(:crypto.compute_key(:ecdh,roccoP,maximK,scheme),0,32)
        roccoS = :binary.part(:crypto.compute_key(:ecdh,maximP,roccoK,scheme),0,32)
        x = encrypt(:aes_256_cbc, "Success!", maximS)
        "Success!" == decrypt(:aes_256_cbc, x, roccoS)
        :ok
    end
      </figure></code>

     <p>На цьому можна було би зупинитись і почати писати псевдо-захищений
        месенжер, як всі роблять, але тут дуже багато безпекових н'юансів
        починаючи від IV педінгів, HKDF і AES-WRAP протоколів, і закінчуючи власне CMS.
        Тому переходимо до наступного параграфу.</p>

    <h4>Генерація криптографічного повідомлення CMS</h4>

    <hr>

     <p>
     [1]. <a href="https://tonpa.guru/stream/2020/2020-02-03 Кваліфікований Електронний Підпис.htm">Кваліфікований Електронний Підпис України</a><br>
     [2]. <a href="https:///tonpa.guru/stream/2023/2023-06-22 Месенжер.htm">Сохацький пише Месенжер</a><br>
     [3]. <a href="https://chat.erp.uno">SYNRC CHAT</a><br>
     [4]. <a href="https://tonpa.guru/stream/2010/2010-10-18 LDAP.htm">Як написати LDAP сервер за 30 хвилин</a><br>
     [5]. <a href="https://soatok.blog/2021/11/17/understanding-hkdf/">Understanding HKDF</a><br>
     [6]. <a href="https://gist.github.com/5HT/86f25408ed74ddb090d2ed9267b33afb">CMS S/MIME compatible MUA SMTP clients</a><br>
     [7]. <a href="https://thehackernews.com/2019/04/email-signature-spoofing.html">Over Dozen Popular Email Clients Found Vulnerable to Signature Spoofing Attacks</a><br>
     </p>

    </section>
</main>
<footer><a href="https://instagram.com/5HT/">Намдак Тöнпа</a> <span class="heart">&nbsp;❤&nbsp;</span> </footer>
</body>
</html>

